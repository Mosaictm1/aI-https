// ============================================
// Prisma Schema - AI-HTTP Database
// ============================================
// Docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // For Supabase
}

// ==================== ENUMS ====================

enum Plan {
  FREE
  PRO
  TEAM
  ENTERPRISE
}

enum InstanceStatus {
  CONNECTED
  DISCONNECTED
  ERROR
  SYNCING
}

enum ExecutionStatus {
  RUNNING
  SUCCESS
  FAILED
  WAITING
  CANCELED
}

enum HttpMethod {
  GET
  POST
  PUT
  PATCH
  DELETE
  HEAD
  OPTIONS
}

// ==================== MODELS ====================

/// المستخدمون في النظام
model User {
  id              String    @id @default(cuid())
  email           String    @unique
  password        String
  name            String
  avatar          String?
  plan            Plan      @default(FREE)
  settings        Json      @default("{}")
  emailVerified   Boolean   @default(false)
  verifyToken     String?   @unique
  resetToken      String?   @unique
  resetTokenExp   DateTime?
  twoFactorEnabled Boolean  @default(false)
  twoFactorSecret String?

  // Relations
  instances       Instance[]
  requests        Request[]
  apiKeys         ApiKey[]
  aiAnalyses      AiAnalysis[]
  sessions        Session[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([email])
  @@map("users")
}

/// جلسات المستخدم
model Session {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  token        String   @unique
  refreshToken String   @unique
  userAgent    String?
  ipAddress    String?
  
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@map("sessions")
}

/// حسابات n8n المتصلة
model Instance {
  id           String         @id @default(cuid())
  userId       String
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name         String
  url          String
  apiKey       String         // Encrypted
  status       InstanceStatus @default(DISCONNECTED)
  version      String?
  lastSync     DateTime?
  lastError    String?
  
  // Relations
  workflows    Workflow[]

  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@unique([userId, url])
  @@index([userId])
  @@index([status])
  @@map("instances")
}

/// الـ Workflows من n8n
model Workflow {
  id           String    @id @default(cuid())
  instanceId   String
  instance     Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  
  n8nId        String
  name         String
  active       Boolean   @default(false)
  nodes        Json      // Array of nodes
  connections  Json      // Connections between nodes
  settings     Json      @default("{}")
  tags         String[]  @default([])
  
  // Statistics
  totalExecutions      Int @default(0)
  successfulExecutions Int @default(0)
  
  // Relations
  executions   Execution[]

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([instanceId, n8nId])
  @@index([instanceId])
  @@index([active])
  @@map("workflows")
}

/// تنفيذات الـ Workflows
model Execution {
  id             String          @id @default(cuid())
  workflowId     String
  workflow       Workflow        @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  
  n8nExecutionId String
  status         ExecutionStatus
  mode           String          // manual, webhook, trigger
  
  data           Json?           // Execution data
  error          Json?           // Error details
  
  startedAt      DateTime
  finishedAt     DateTime?
  duration       Float?          // In seconds
  
  // Relations
  aiAnalyses     AiAnalysis[]

  @@unique([workflowId, n8nExecutionId])
  @@index([workflowId])
  @@index([status])
  @@index([startedAt])
  @@map("executions")
}

/// HTTP Requests المحفوظة
model Request {
  id           String     @id @default(cuid())
  userId       String
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name         String
  description  String?
  method       HttpMethod
  url          String
  headers      Json       @default("{}")
  params       Json       @default("{}")
  body         Json?
  auth         Json?      // Auth type and details
  
  // Metadata
  lastUsed     DateTime?
  usageCount   Int        @default(0)
  favorite     Boolean    @default(false)
  tags         String[]   @default([])
  
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([userId])
  @@index([method])
  @@map("requests")
}

/// مفاتيح API للمستخدمين
model ApiKey {
  id           String    @id @default(cuid())
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name         String
  key          String    @unique  // Encrypted, shown once
  keyPrefix    String              // First 8 chars for display
  permissions  String[]  @default([])
  
  lastUsedAt   DateTime?
  expiresAt    DateTime?
  isRevoked    Boolean   @default(false)
  
  createdAt    DateTime  @default(now())

  @@index([userId])
  @@index([key])
  @@map("api_keys")
}

/// تحليلات AI للأخطاء
model AiAnalysis {
  id           String     @id @default(cuid())
  userId       String
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  executionId  String?
  execution    Execution? @relation(fields: [executionId], references: [id], onDelete: SetNull)
  
  errorData    Json       // Original error data
  requestData  Json?      // Request data
  
  analysis     Json       // Analysis result
  suggestions  Json       // Suggested solutions
  confidence   Float      // Confidence score (0-1)
  
  applied      Boolean    @default(false)  // Was fix applied
  helpful      Boolean?   // User feedback
  
  createdAt    DateTime   @default(now())

  @@index([userId])
  @@index([executionId])
  @@map("ai_analyses")
}

/// قوالب الخدمات
model Template {
  id           String   @id @default(cuid())
  
  serviceId    String   // stripe, shopify, etc.
  serviceName  String
  serviceIcon  String?
  category     String   // payments, ecommerce, etc.
  
  endpointId   String
  endpointName String
  description  String?
  
  method       HttpMethod
  urlTemplate  String
  headers      Json     @default("{}")
  bodyTemplate Json?
  
  variables    Json     @default("[]")  // Required variables
  documentation String?
  
  isOfficial   Boolean  @default(true)
  usageCount   Int      @default(0)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([serviceId, endpointId])
  @@index([serviceId])
  @@index([category])
  @@map("templates")
}

/// سجل التدقيق
model AuditLog {
  id           String   @id @default(cuid())
  
  userId       String?
  action       String   // user.login, instance.create, etc.
  resource     String   // Resource type
  resourceId   String?  // Resource ID
  
  ipAddress    String?
  userAgent    String?
  
  success      Boolean
  details      Json?    // Additional details
  
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}
